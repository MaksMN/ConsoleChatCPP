# Консольный чат
## 25.7. Домашнее задание

#### ЗАДАЧА
> Организовать хранение данных чата в базе данных.
#### Задание повышенной сложности
> Организуйте работу с базой данных иным способом. То есть если вы сначала использовали API MySQL, то сделайте вариант чата с использованием ODBC и наоборот, если вы сделали чат через ODBC, то напишите версию с использованием API MySQL.

#### Реализовано
1. Хранение данных чата в базе данных Mysql
2. Задание повышенной сложности. Работа с базой данных двумя способами: API MySQL и ODBC
3. Кроссплатформенное решение. Клиент работает в обеих ОС. Сервер на Windows работает через API MySQL и ODBC, на Linux только API MySQL.
4. Требования практикума проектирования БД
 - Id пользователя;
 - Имя пользователя;
 - Фамилию пользователя;
 - Email пользователя;
 - Хэш пароля пользователя;
 - Id сообщения;
 - Id отправителя;
 - Id получателя;
 - Текст сообщения;
 - Дату отправки сообщения;
 - Статус сообщения, указывающий, прочитано ли сообщение;
 - Статус сообщения, указывающий, доставлено ли сообщение.
  Статусы сообщений работают следующим образом: сообщение попало в базу - доставлено; если его прочитал не автор - прочитано; если его прочитал только автор - доставлено.

Отдельная таблица для хеша паролей с триггером на добавление пользователя.
Таблица users имеет связь с другими таблицами один ко многим.
Так же за счет внешних ключей, связей и триггеров при удалении пользователя удаляется запись из таблицы хешей паролей, а сообщения получают статус "пользователь удален" "author_id = null".

Таблица наполнена тестовыми данными
 - Testerov Tester test@test.ru;
 - Viking Eric Eric@north.se;
 - Viking Olaf Olaf@north.se;
 - Viking Baleog Baleog@north.se;
 - ТипичнаяФамилия ТипичноеИмя typical@typical.ru;
 - Проверка_Поля_на_достаточно_длинную_и_нестандартную_фамилию такое_же_длинное_имя_с_нестандартными_символами_#!@$#?\\_ почта@русская.ру.

Для авторизации этих пользователей используйте команду: ```/auth:login:pass```
Логины тестовых пользователей: test, olaf, baleog, typical, длинный. Пароль у всех: pass.

База наполнена рандомными сообщениями.

Решена проблема корректного отображения данных в таблице сообщений после удаления пользователя.

В чате имеется система личных и публичных сообщений. Возможность модерации контента и пользователей администраторами. Выбор пользователей и чатов по различным параметрам.

Клиент программы устойчив к падению сервера и отключению базы данных. При получении на клиенте сообщений о проблемах БД в консоли сервера отображается диагностическая информация. Если при сбоях БД на клиенте вводить произвольные команды, сервер будет перезапускать подключение к БД.

### Документация пользователя

**Состав проекта:**
1. Папка Client - клиентская часть приложения.
2. Папка Server - серверная часть приложения.
3. Папка Misc - содержит различные классы и функции, необходимые для клиента и сервера.
4. Папка Mysqldump - содержит дампы базы данных.
5. Папка .console_chat  - файлы конфигурации клиента и сервера.
6. Файлы сборки проекта - make_client make_server для обеих ОС.

**Сборка проекта:**

Для начала надо развернуть базу данных из дампа, который находится в папке Mysqldump
Это можно сделать при помощи любых программ для управления БД Mysql. Или командой
```
mysql -uroot -ppass ${DBNAME} < ~/console_chat_dump.sql
```
**Базу данных лучше всего развертывать root пользователю. Это связано с ограничениями на создание триггеров в последних версиях Mysql.** 

Либо в дампе найти строки ```CREATE DEFINER=`root`@`localhost``` и заменить ее на своего пользователя.

В make* файлах содержатся готовые сценарии сборки g++.
На что стоит обратить внимание:

Сборка клиента и сервера должна осуществляться с флагом -std=c++20

Для сборки сервера на Windows обратить внимание где у вас установлена Mysql и выставить в параметрах запуска свои пути включения и к библиотекам разработчика:
```
"-Ic:\Program Files\MySQL\MySQL Server 8.0\include" "-Lc:\Program Files\MySQL\MySQL Server 8.0\lib" -llibmysql -lws2_32 -lodbc32
```
В Linux надо установить библиотеки разработчика
```
$ sudo apt install libmysqlclient-dev
```
И в параметрах запуска указать:
```
`mysql_config --cflags --libs`
```
**Использование программы:**
Сервер однопоточный не поддерживает ввод команд. В его окне будут отображаться ошибки БД и различная сервисная информация.
Можно запускать одновременно несколько клиентов. Не смотря на однопоточность клиенты могут работать параллельно из любых ОС. Какая либо синхронизация клиентов не требуется.

Перед запуском клиентов и сервера надо сначала настроить файлы конфигурации которые должны находиться на путях поддержки и рабочих каталогах программы в папке .console_chat

*.console_chat\client.ini*
```ini
[GENERAL]
sv_address=127.0.0.1
sv_port=7777
```
*.console_chat\server.ini*
```ini
# Настройки сервера и подключения к базе
[GENERAL]
sv_port=7777 ;порт который слушает сервер чата

[DB]
; Выбор клиента базы данных.
; mysqlapi | odbc
db=mysqlapi
server=127.0.0.1
port=3306
dbuser=dbuser
dbpass=dbpass
dbname=console_chat
db_character_set=utf8mb4
```
В случае если данные файлы не найдены, будет использована конфигурация по умолчанию.

Коннектор ODBC настроить: MySQL ODBC 8.0 ANSI Driver и utf8mb4

<hr>
Функционал реализован при помощи слэш-команд

```
/command или /command:value1:value2:value..n
``` 
В процессе работы программа будет запрашивать определенные команды, которые вам надо будет вводить.

Введите команду ```/hello``` чтобы проверить соединение с сервером.

Есть ряд команд, которые работают всегда даже когда вас просят ввести что-то другое:

Команды, которые можно вызвать в любое время:
 - Команда ```/hello``` - Опрос сервера;
 - Команда ```/help``` - Справка;
 - Команда ```/quit``` - Закрыть клиент;

Команды, которые можно вызвать в любое время авторизованным пользователям:
 - Команда ```/chat``` - Общий чат;
 - Команда ```/private``` - Личные сообщения;
 - Команда ```/private:u:userid``` - Начать личную беседу с пользователем. Поиск по userid;
 - Команда ```/private:ul:login``` - Начать личную беседу с пользователем. Поиск по логину;
 - Команда ```/users``` - Список пользователей;
 - Команда ```/profile``` - Сменить имя логин пароль;
 - Команда ```/logout``` - Выйти из чата; 
 - Команда ```/sv_quit``` - (admin)завершить работу сервера;

В чате есть сервисный администратор: логин - admin, пароль - 1234. Авторизуйтесь с этими данными в клиенте и смените пароль командой ```/profile```
Сервисный администратор может может назначать других администраторов.

Все администраторы могут скрывать/удалять сообщения общего чата и блокировать пользователей.
На страницах чата у администраторов есть дополнительные команды управления сообщениями и пользователями.

Клиент программы устойчив к падению сервера и отключению базы данных. При получении на клиенте сообщений о проблемах БД в консоли сервера отображается диагностическая информация. Если при сбоях БД на клиенте вводить произвольные команды, сервер будет перезапускать подключение к БД.

### Концепция приложения

**Сетевое взаимодействие**

Принцип сетевого взаимодействия клиентов с сервером создан по аналогии принципов действия работы вебсайтов. Клиент по сути является импровизированным браузером, а вводимые команды URL адресами. После ввода логина пароля, сервер генерирует клиенту секретный сессионный ключ и потом узнает его по этому ключу. Тот же принцип как Cookie вебсайтов.
Более подробно принцип сетевого взаимодействия расписан в итоговом задании предыдущего модуля https://github.com/MaksMN/ConsoleChatFP/tree/HW_mod20

**Работа с БД**

Оболочка работы с БД находится в папке *Server\DBClient* Выбор API MySQL или ODBC реализован за счет динамического полиморфизма.

Класс DBClient объявляет поля с типами MySQLAPI и ODBC которые являются наследниками интерфейса DBCore.

Далее в зависимости от настроек выбора DBCore *_DBprovider присваивается значение ссылка на MySQLAPI или ODBC.

В дальнейшем другие модули программы могут обращаться к базе данных:

```cpp
dbclient.DBprovider()->DBget(args);

dbclient.DBprovider()->DBset(args);
```
Другим классам программы которые вызывают данные методы не важно какая настройка выбрана MySQLAPI или ODBC взаимодействием с БД управляет DBprovider.

**Остальное**

Server\ChatCore - структуры сообщения и пользователя.

Server\ChatPages - это фронтенд программы, здесь осуществляется обработка ввода пользователя и выдача результата клиенту.

Server\Socket - сетевая инфраструктура сервера.

Client - очень простое приложение. Его задача отправлять ввод пользователя на сервер и печатать все что приходит с сервера. Больше в нем нет никакого функционала.

Все контейнеры из предыдущих домашних заданий упразднены так как база данных поддерживает более широкие возможности хранения и выдачи результатов. 